-- ==========================================================================================================
-- 添加单元模板和单元实例的预估时长字段
-- ==========================================================================================================
-- 
-- 脚本名称: 24_add_unit_estimated_duration.sql
-- 创建日期: 2024-12-14
-- 兼容版本: MySQL 5.7.x, 8.0.x
-- 字符集: utf8mb4
-- 排序规则: utf8mb4_unicode_ci
--
-- ==========================================================================================================
-- 功能说明:
-- ==========================================================================================================
--
-- 为以下表添加 estimated_duration 字段：
-- 1. pbl_unit_templates (单元模板表)
-- 2. pbl_units (单元实例表)
--
-- 该字段用于存储单元的预估完成时长（字符串格式，如 "2周"、"4学时" 等）
--
-- 背景：
-- - 代码模型中已定义 estimated_duration 字段
-- - 但数据库表中缺少此字段，导致查询报错
-- - 模板表和实例表都需要此字段，以支持从模板创建实例时继承该值
--
-- 注意：
-- - 此脚本仅能执行一次，重复执行会报错（字段已存在）
-- - 如需支持重复执行，请使用带条件检查的存储过程版本
--
-- ==========================================================================================================

-- 设置字符集
SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci;

-- ==========================================================================================================
-- 1. 为 pbl_unit_templates 表添加 estimated_duration 字段
-- ==========================================================================================================

-- 在 key_concepts 字段之后添加 estimated_duration 字段
ALTER TABLE `pbl_unit_templates` 
ADD COLUMN `estimated_duration` VARCHAR(50) DEFAULT NULL 
COMMENT '预估完成时长（如：2周、4学时）' 
AFTER `key_concepts`;

-- ==========================================================================================================
-- 2. 为 pbl_units 表添加 estimated_duration 字段
-- ==========================================================================================================

-- 在 learning_guide 字段之后添加 estimated_duration 字段
ALTER TABLE `pbl_units` 
ADD COLUMN `estimated_duration` VARCHAR(50) DEFAULT NULL 
COMMENT '预估完成时长（如：2周、4学时）' 
AFTER `learning_guide`;

-- ==========================================================================================================
-- 验证字段添加结果
-- ==========================================================================================================

SELECT 
    '验证结果' AS info_type,
    table_name AS '表名',
    column_name AS '字段名',
    column_type AS '数据类型',
    column_comment AS '备注'
FROM information_schema.columns
WHERE table_schema = DATABASE()
  AND table_name IN ('pbl_unit_templates', 'pbl_units')
  AND column_name = 'estimated_duration'
ORDER BY table_name;

-- ==========================================================================================================
-- 使用说明
-- ==========================================================================================================

SELECT '==========================================================================================================' AS ' ';
SELECT 'estimated_duration 字段添加完成！' AS '状态';
SELECT '==========================================================================================================' AS ' ';
SELECT '已添加到以下表：' AS ' ';
SELECT '1. pbl_unit_templates (单元模板表)' AS '';
SELECT '2. pbl_units (单元实例表)' AS '';
SELECT '==========================================================================================================' AS ' ';
SELECT '字段说明：' AS ' ';
SELECT '- 字段名：estimated_duration' AS '';
SELECT '- 数据类型：VARCHAR(50)' AS '';
SELECT '- 用途：存储单元预估完成时长（字符串格式，如 "2周"、"4学时" 等）' AS '';
SELECT '- 默认值：NULL（可选字段）' AS '';
SELECT '==========================================================================================================' AS ' ';

-- ==========================================================================================================
-- 脚本结束
-- ==========================================================================================================
