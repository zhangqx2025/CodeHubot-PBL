# æ•°æ®åº“è¡¨é‡å‘½å - å®æ–½å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº†æ ¹æ®ã€Šæ•°æ®åº“è¡¨é‡å‘½å-åç«¯ä»£ç ä¿®æ”¹æŒ‡å—.mdã€‹å®Œæˆçš„åç«¯ä»£ç ä¿®æ”¹å·¥ä½œã€‚

**æ‰§è¡Œæ—¶é—´ï¼š** 2025-12-09  
**Gitåˆ†æ”¯ï¼š** feature/reorganize-school-config-menu  
**Commitï¼š** ea672fdecccbc14609a34faf26b80c0c3d97f80f

---

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. åç«¯ä»£ç ä¿®æ”¹

#### ğŸ“ backend/app/models/admin.py
- ä¿®æ”¹è¡¨åï¼š`aiot_core_users` â†’ `core_users`
- æ›´æ–°ç±»æ–‡æ¡£å­—ç¬¦ä¸²ä¸­çš„è¡¨åå¼•ç”¨

```python
# ä¿®æ”¹å‰
__tablename__ = "aiot_core_users"

# ä¿®æ”¹å
__tablename__ = "core_users"
```

#### ğŸ“ backend/app/models/school.py
- ä¿®æ”¹è¡¨åï¼š`aiot_schools` â†’ `core_schools`

```python
# ä¿®æ”¹å‰
__tablename__ = "aiot_schools"

# ä¿®æ”¹å
__tablename__ = "core_schools"
```

#### ğŸ“ backend/app/models/pbl.py
æ›´æ–°äº†ä»¥ä¸‹æ¨¡å‹ä¸­çš„å¤–é”®æ³¨é‡Šï¼ˆå…±12å¤„ï¼‰ï¼š

1. **PBLCourse**
   - `creator_id`: Foreign Key to `core_users`
   - `school_id`: Foreign Key to `core_schools`

2. **PBLTaskProgress**
   - `user_id`: Foreign Key to `core_users`
   - `graded_by`: Foreign Key to `core_users`

3. **PBLSchoolCourse**
   - `school_id`: Foreign Key to `core_schools`
   - `assigned_by`: Foreign Key to `core_users`

4. **PBLCourseEnrollment**
   - `user_id`: Foreign Key to `core_users`

5. **PBLProjectOutput**
   - `user_id`: Foreign Key to `core_users`
   - `group_id`: Foreign Key to `pbl_groups` (åŒæ—¶ä¿®æ­£)

6. **PBLProject**
   - `group_id`: Foreign Key to `pbl_groups` (åŒæ—¶ä¿®æ­£)

7. **PBLLearningProgress**
   - `user_id`: Foreign Key to `core_users`

8. **PBLVideoWatchRecord**
   - `user_id`: Foreign Key to `core_users`

9. **PBLVideoUserPermission**
   - `user_id`: Foreign Key to `core_users`

10. **PBLVideoPlayProgress**
    - `user_id`: Foreign Key to `core_users`

11. **PBLVideoPlayEvent**
    - `user_id`: Foreign Key to `core_users`

### 2. SQLè¿ç§»è„šæœ¬

åˆ›å»ºäº†å®Œæ•´çš„æ•°æ®åº“è¿ç§»è„šæœ¬å¥—ä»¶ï¼š

#### ğŸ“ SQL/update/01_rename_tables_core_users_schools.sql
- **åŠŸèƒ½ï¼š** æ‰§è¡Œè¡¨é‡å‘½åæ“ä½œ
- **å†…å®¹ï¼š**
  - é‡å‘½å `aiot_core_users` â†’ `core_users`
  - é‡å‘½å `aiot_schools` â†’ `core_schools`
- **ç‰¹æ€§ï¼š**
  - åŒ…å«è¯¦ç»†çš„æ‰§è¡Œè¯´æ˜
  - å…¼å®¹ MySQL 5.7-8.0
  - åŒ…å«éªŒè¯æ­¥éª¤

#### ğŸ“ SQL/update/02_verify_rename.sql
- **åŠŸèƒ½ï¼š** éªŒè¯è¡¨é‡å‘½åæ˜¯å¦æˆåŠŸ
- **æ£€æŸ¥é¡¹ï¼š**
  - æ–°è¡¨æ˜¯å¦å­˜åœ¨
  - æ•°æ®è®°å½•æ•°é‡
  - è¡¨ç»“æ„å’Œç´¢å¼•
  - æ•°æ®å®Œæ•´æ€§
  - å…³è”å…³ç³»éªŒè¯

#### ğŸ“ SQL/update/03_rollback_if_needed.sql
- **åŠŸèƒ½ï¼š** ç´§æ€¥å›æ»šè„šæœ¬
- **ç”¨é€”ï¼š** å¦‚æœå‡ºç°é—®é¢˜ï¼Œå¿«é€Ÿå›æ»šåˆ°åŸè¡¨å
- **åŒ…å«ï¼š** å®Œæ•´çš„å›æ»šæ“ä½œæ­¥éª¤

---

## ğŸ” ä»£ç éªŒè¯

### éªŒè¯æ–¹æ³•
æ‰§è¡Œäº†å…¨å±€æœç´¢ï¼Œç¡®è®¤æ²¡æœ‰é—æ¼çš„æ—§è¡¨åå¼•ç”¨ï¼š

```bash
grep -r "aiot_core_users\|aiot_schools" backend/app --include="*.py"
# ç»“æœï¼šæ— åŒ¹é…é¡¹ âœ“
```

### éªŒè¯ç»“æœ
- âœ… æ‰€æœ‰æ¨¡å‹æ–‡ä»¶å·²æ›´æ–°
- âœ… æ‰€æœ‰å¤–é”®æ³¨é‡Šå·²åŒæ­¥
- âœ… æ— é—æ¼çš„ç¡¬ç¼–ç è¡¨å
- âœ… æ— åŸå§‹SQLæŸ¥è¯¢å¼•ç”¨æ—§è¡¨å

---

## ğŸ“¦ Gitæäº¤ä¿¡æ¯

```
commit ea672fdecccbc14609a34faf26b80c0c3d97f80f
Author: å¼ é½å‹‹ <zhangqx@ss.pku.edu.cn>
Date:   Tue Dec 9 15:32:23 2025 +0800

    refactor: é‡å‘½åæ ¸å¿ƒæ•°æ®åº“è¡¨ä»¥ç¬¦åˆæ¨¡å—åŒ–å‘½åè§„èŒƒ
    
    - æ›´æ–°è¡¨åï¼š
      - aiot_core_users â†’ core_users
      - aiot_schools â†’ core_schools
```

### ä¿®æ”¹ç»Ÿè®¡
- 6ä¸ªæ–‡ä»¶å·²ä¿®æ”¹
- 206è¡Œæ–°å¢
- 18è¡Œåˆ é™¤

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šå¤‡ä»½æ•°æ®åº“
```bash
# è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
mysqldump -uç”¨æˆ·å -p æ•°æ®åº“å > backup_$(date +%Y%m%d_%H%M%S).sql
```

### ç¬¬äºŒæ­¥ï¼šåœæ­¢åç«¯æœåŠ¡
```bash
# è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
systemctl stop codehubot-pbl-backend
# æˆ–
pm2 stop codehubot-pbl-backend
```

### ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§»
```bash
# è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
mysql -uç”¨æˆ·å -p æ•°æ®åº“å < SQL/update/01_rename_tables_core_users_schools.sql
```

### ç¬¬å››æ­¥ï¼šéªŒè¯æ•°æ®åº“è¿ç§»
```bash
# è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
mysql -uç”¨æˆ·å -p æ•°æ®åº“å < SQL/update/02_verify_rename.sql
```

### ç¬¬äº”æ­¥ï¼šæ›´æ–°åç«¯ä»£ç 
```bash
# è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd /path/to/CodeHubot-PBL
git pull origin feature/reorganize-school-config-menu
```

### ç¬¬å…­æ­¥ï¼šå¯åŠ¨åç«¯æœåŠ¡
```bash
# è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
systemctl start codehubot-pbl-backend
# æˆ–
pm2 start codehubot-pbl-backend
```

### ç¬¬ä¸ƒæ­¥ï¼šåŠŸèƒ½æµ‹è¯•
æµ‹è¯•ä»¥ä¸‹åŠŸèƒ½ç¡®è®¤æ­£å¸¸ï¼š
- [ ] ç”¨æˆ·ç™»å½•ï¼ˆå­¦ç”Ÿç«¯ã€ç®¡ç†å‘˜ç«¯ï¼‰
- [ ] ç”¨æˆ·æ³¨å†Œ
- [ ] å­¦æ ¡ç®¡ç†ï¼ˆæŸ¥è¯¢ã€åˆ›å»ºã€æ›´æ–°ï¼‰
- [ ] è¯¾ç¨‹åˆ—è¡¨æŸ¥è¯¢
- [ ] å­¦ç”Ÿé€‰è¯¾
- [ ] è§†é¢‘è§‚çœ‹

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### é‡è¦æç¤º
1. **å¤‡ä»½ä¼˜å…ˆï¼š** æ‰§è¡Œä»»ä½•æ“ä½œå‰åŠ¡å¿…å®Œæ•´å¤‡ä»½æ•°æ®åº“
2. **ä¸šåŠ¡ä½å³°æœŸï¼š** å»ºè®®åœ¨ä¸šåŠ¡ä½å³°æœŸï¼ˆå¦‚å‡Œæ™¨ï¼‰æ‰§è¡Œ
3. **é¢„ç•™æ—¶é—´ï¼š** æ•´ä¸ªè¿‡ç¨‹é¢„è®¡éœ€è¦10-20åˆ†é’Ÿ
4. **å›æ»šå‡†å¤‡ï¼š** ä¿ç•™å¤‡ä»½å’Œå›æ»šè„šæœ¬ï¼Œä»¥å¤‡ä¸æ—¶ä¹‹éœ€

### å·²çŸ¥å½±å“
- è¡¨é‡å‘½åæœŸé—´ï¼Œç³»ç»Ÿéœ€è¦åœæœº
- ä¸å½±å“æ•°æ®å†…å®¹ï¼Œä»…ä¿®æ”¹è¡¨å
- ä¸å½±å“è¡¨ç»“æ„å’Œç´¢å¼•
- ä¸å½±å“æ•°æ®å…³è”å…³ç³»

### å…¼å®¹æ€§
- âœ… MySQL 5.7
- âœ… MySQL 8.0
- âœ… MariaDB 10.x

---

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šè¡¨ä¸å­˜åœ¨é”™è¯¯
**ç°è±¡ï¼š** å¯åŠ¨åç«¯æœåŠ¡åæŠ¥é”™ "Table 'core_users' doesn't exist"

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥æ•°æ®åº“è¿ç§»æ˜¯å¦æ‰§è¡ŒæˆåŠŸ
2. æ‰§è¡ŒéªŒè¯è„šæœ¬ `02_verify_rename.sql`
3. å¦‚æœè¡¨æœªé‡å‘½åï¼Œé‡æ–°æ‰§è¡Œ `01_rename_tables_core_users_schools.sql`

### é—®é¢˜2ï¼šå¤–é”®çº¦æŸé”™è¯¯
**ç°è±¡ï¼š** æ•°æ®åº“æ“ä½œæ—¶æŠ¥å¤–é”®çº¦æŸé”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
- PBLç³»ç»Ÿçš„å¤–é”®æ˜¯åº”ç”¨å±‚ç»´æŠ¤çš„ï¼Œæ²¡æœ‰æ•°æ®åº“çº§å¤–é”®çº¦æŸ
- å¦‚æœå‡ºç°æ­¤é”™è¯¯ï¼Œè¯´æ˜å¯èƒ½æœ‰å…¶ä»–ç³»ç»Ÿçš„è¡¨ä¾èµ–è¿™äº›è¡¨
- éœ€è¦æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–ç³»ç»Ÿï¼ˆå¦‚CodeHubotï¼‰å…±äº«è¿™äº›è¡¨

### é—®é¢˜3ï¼šéœ€è¦å›æ»š
**åœºæ™¯ï¼š** è¿ç§»åå‡ºç°ä¸¥é‡é—®é¢˜ï¼Œéœ€è¦ç´§æ€¥å›æ»š

**æ“ä½œæ­¥éª¤ï¼š**
1. åœæ­¢åç«¯æœåŠ¡
2. æ‰§è¡Œå›æ»šè„šæœ¬ï¼š
   ```bash
   mysql -uç”¨æˆ·å -p æ•°æ®åº“å < SQL/update/03_rollback_if_needed.sql
   ```
3. è¿˜åŸåç«¯ä»£ç ï¼š
   ```bash
   git checkout <ä¸Šä¸€ä¸ªcommit> -- backend/app/models/
   ```
4. é‡å¯åç«¯æœåŠ¡

---

## ğŸ“Š å½±å“è¯„ä¼°

### å—å½±å“çš„æ¨¡å—
- âœ… ç”¨æˆ·è®¤è¯å’Œæˆæƒ
- âœ… å­¦æ ¡ç®¡ç†
- âœ… è¯¾ç¨‹ç®¡ç†
- âœ… å­¦ç”Ÿé€‰è¯¾
- âœ… ä»»åŠ¡æäº¤
- âœ… è§†é¢‘è§‚çœ‹
- âœ… å­¦ä¹ è¿›åº¦è¿½è¸ª

### ä¸å—å½±å“çš„éƒ¨åˆ†
- âœ… å‰ç«¯ä»£ç ï¼ˆå‰ç«¯é€šè¿‡APIè®¿é—®ï¼Œä¸ç›´æ¥æ“ä½œè¡¨ï¼‰
- âœ… APIæ¥å£ï¼ˆæ¥å£å®šä¹‰æœªå˜åŒ–ï¼‰
- âœ… ä¸šåŠ¡é€»è¾‘ï¼ˆé€»è¾‘å±‚æœªå˜åŒ–ï¼‰
- âœ… æ•°æ®å†…å®¹ï¼ˆä»…è¡¨åå˜åŒ–ï¼Œæ•°æ®å®Œæ•´ä¿ç•™ï¼‰

---

## âœ¨ é¢å¤–æ”¹è¿›

åœ¨ä¿®æ”¹è¿‡ç¨‹ä¸­ï¼ŒåŒæ—¶ä¿®æ­£äº†ä»¥ä¸‹ä¸ä¸€è‡´çš„å¤–é”®æ³¨é‡Šï¼š
- `aiot_course_groups` â†’ `pbl_groups`ï¼ˆåœ¨ PBLProject å’Œ PBLProjectOutput ä¸­ï¼‰

è¿™ä½¿å¾—æ‰€æœ‰å¤–é”®æ³¨é‡Šéƒ½ç¬¦åˆå®é™…çš„è¡¨å‘½åè§„èŒƒã€‚

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœåœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- **å¼€å‘è€…ï¼š** å¼ é½å‹‹
- **é‚®ç®±ï¼š** zhangqx@ss.pku.edu.cn
- **Gitæäº¤ï¼š** ea672fdecccbc14609a34faf26b80c0c3d97f80f

---

## ğŸ“… ä¸‹ä¸€æ­¥è®¡åˆ’

1. åœ¨è¿œç¨‹æœåŠ¡å™¨æ‰§è¡Œæ•°æ®åº“è¿ç§»
2. éƒ¨ç½²æ›´æ–°åçš„åç«¯ä»£ç 
3. è¿›è¡Œå®Œæ•´çš„åŠŸèƒ½æµ‹è¯•
4. åˆå¹¶åˆ° main åˆ†æ”¯ï¼ˆä¿ç•™å½“å‰åˆ†æ”¯ï¼‰
5. ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´ï¼š** 2025-12-09  
**ç‰ˆæœ¬ï¼š** v1.0  
**çŠ¶æ€ï¼š** âœ… ä»£ç ä¿®æ”¹å®Œæˆï¼Œç­‰å¾…æ•°æ®åº“è¿ç§»
