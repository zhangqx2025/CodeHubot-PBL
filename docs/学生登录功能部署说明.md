# 学生登录功能部署说明

## 功能概述

已实现学生端真实登录功能，可以获取后端真实的 JWT token。

## 部署步骤

### 1. 数据库更新

在远程服务器上执行以下SQL脚本来创建测试学生用户：

```bash
# 登录MySQL数据库
mysql -u username -p aiot_admin

# 执行SQL脚本
source /path/to/SQL/update/01_insert_test_student.sql
```

或者直接执行：

```bash
mysql -u username -p aiot_admin < SQL/update/01_insert_test_student.sql
```

### 2. 测试用户信息

脚本将创建3个测试学生用户：

| 用户名 | 学号 | 学校代码 | 密码 | 姓名 |
|--------|------|----------|------|------|
| 20240001@DEMO_SCHOOL | 20240001 | DEMO_SCHOOL | 123456 | 张三 |
| 20240002@DEMO_SCHOOL | 20240002 | DEMO_SCHOOL | 123456 | 李四 |
| 20240003@DEMO_SCHOOL | 20240003 | DEMO_SCHOOL | 123456 | 王五 |

### 3. 验证登录功能

#### 后端验证

在后端目录下运行测试脚本：

```bash
cd backend
python3 test_student_login.py
```

该脚本将：
- 验证密码哈希是否正确
- 检查测试用户是否存在
- 测试密码验证逻辑

#### 前端验证

1. 访问学生登录页面：http://localhost:8082/login
2. 输入测试账号：
   - 用户名：20240001@DEMO_SCHOOL
   - 密码：123456
3. 点击登录按钮
4. 成功后会跳转到学生首页

### 4. 前端代码主要更改

#### API配置更新

修改了 `frontend/src/api/config.js`：
- 添加了正确的学生认证端点
- STUDENT_LOGIN: `/student/auth/login`
- STUDENT_REFRESH: `/student/auth/refresh`
- STUDENT_ME: `/student/auth/me`

#### 登录流程实现

修改了 `frontend/src/api/auth.js`：
- 启用真实API调用，移除mock数据
- 实现用户名格式转换（student_id@school_code）
- 正确处理后端返回的token和用户信息

### 5. API路由信息

#### 后端路由

- 学生登录：`POST /api/v1/student/auth/login`
- 刷新Token：`POST /api/v1/student/auth/refresh`
- 获取用户信息：`GET /api/v1/student/auth/me`

#### 请求格式

登录请求：
```json
{
  "username": "20240001@DEMO_SCHOOL",
  "password": "123456"
}
```

登录响应：
```json
{
  "code": 0,
  "message": "登录成功",
  "data": {
    "access_token": "eyJ...",
    "refresh_token": "eyJ...",
    "token_type": "bearer",
    "user": {
      "id": 1,
      "username": "20240001@DEMO_SCHOOL",
      "name": "张三",
      "role": "student",
      "student_number": "20240001",
      ...
    }
  }
}
```

### 6. 常见问题

#### 问题1：登录提示"用户名或密码错误"

**解决方案：**
1. 确认已执行 SQL 更新脚本
2. 检查数据库中是否存在该用户
3. 验证密码哈希是否正确

```sql
-- 查询用户
SELECT * FROM aiot_core_users WHERE username = '20240001@DEMO_SCHOOL';
```

#### 问题2：登录后无法访问其他接口

**解决方案：**
1. 检查前端是否正确保存了 token
2. 查看浏览器 localStorage 中的 `student_access_token`
3. 检查后端是否正确验证 token

#### 问题3：Token过期

**解决方案：**
- 前端会自动使用 refresh_token 刷新 access_token
- 如果 refresh_token 也过期，需要重新登录

### 7. 安全注意事项

1. **生产环境密码**：在生产环境中，请修改所有测试用户的密码
2. **Token安全**：确保使用 HTTPS 传输 token
3. **密码策略**：建议实施强密码策略
4. **Token过期时间**：根据实际需求调整 token 有效期

### 8. 下一步开发建议

1. 实现密码修改功能
2. 添加"忘记密码"功能
3. 实现双因素认证（可选）
4. 添加登录日志记录
5. 实现账号锁定机制（防暴力破解）

## 技术栈

- 前端：Vue 3 + Element Plus + Pinia
- 后端：FastAPI + SQLAlchemy + MySQL
- 认证：JWT (JSON Web Token)
- 密码加密：PBKDF2-SHA256

